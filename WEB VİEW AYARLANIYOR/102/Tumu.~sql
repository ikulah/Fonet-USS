CREATE OR REPLACE VIEW V_USS_P102_HIZMET AS
SELECT
            "BS"."HASTA_GELIS_ID" AS HK_ID,
            "BS"."ID" AS DETAY_ID,
            (select U.SKRS_KODU from FONETHBS.UZMANLIK U WHERE U.KODU IN (SELECT X.UZMANLIK_KODU FROM FONETHBS.BIRIM X WHERE X.ID = BS.BIRIM_ID))  AS KLINIK_KODU#K,
            USS.GET_GUID_VALUE('c04bee57-c5d4-443d-e040-7b0a6f146a3d',(select U.SKRS_KODU from FONETHBS.UZMANLIK U WHERE U.KODU IN (SELECT X.UZMANLIK_KODU FROM FONETHBS.BIRIM X WHERE X.ID = BS.BIRIM_ID))) AS KLINIK_KODU#A#Z,
            'c04bee57-c5d4-443d-e040-7b0a6f146a3d' AS KLINIK_KODU#C,
            TO_CHAR(CASE WHEN "HH"."ONAY_TARIHI" IS NOT NULL THEN HH.ONAY_TARIHI ELSE HH.ETAR END,'YYYYMMDDHH24MI') AS GERCEKLESME_ZAMANI#Z,
            1 AS ISLEM_TURU#K,
            USS.GET_GUID_VALUE('d03e562d-252e-451f-9a80-98d48b47c2f2',1) AS ISLEM_TURU#A,
            'd03e562d-252e-451f-9a80-98d48b47c2f2' AS ISLEM_TURU#C,
            SUBSTR(REPLACE(HZ.SUT_RESMI_KODU,'.',''),1,6) AS ISLEM_KODU#Z,
            HZ.SUT_RESMI_ADI AS ISLEM_ADI#Z,
            SUBSTR(REPLACE(HZ.GIL_RESMI_KODU,'.',''),1,6) AS GIRISIMSEL_ISLEM_KODU#Z,
            TO_CHAR(GREATEST(HH.ISTEM_TARIHI, HH.ETAR),'YYYYMMDDHH24MI') AS ISLEM_ZAMANI#Z,
            "HH"."MIKTAR" AS ADET#Z,
            CASE WHEN   ROUND(DECODE("HH"."ODEME_TURU",2, HH.MIKTAR * "HH"."HIZMET_FIYAT"),2) <= 6000
                   THEN  ROUND(DECODE(HH.ODEME_TURU,2, HH.MIKTAR * HH.HIZMET_FIYAT),2)
                 WHEN  ROUND(DECODE(HH.ODEME_TURU,2, HH.MIKTAR * HH.HIZMET_FIYAT),2) >= 6000
                   THEN (CASE WHEN ROUND(HZ.SUT_FIYAT * HH.MIKTAR)>6000 THEN 0 ELSE ROUND(HZ.SUT_FIYAT * HH.MIKTAR) END )
                 ELSE 0 END  AS HASTA_TUTARI#Z,
            CASE WHEN   ROUND(DECODE(HH.ODEME_TURU,1, HH.MIKTAR * HH.HIZMET_FIYAT),2) <= 6000
                    THEN  ROUND(DECODE(HH.ODEME_TURU,1, HH.MIKTAR * HH.HIZMET_FIYAT),2)
                 WHEN  ROUND(DECODE(HH.ODEME_TURU,1, HH.MIKTAR * HH.HIZMET_FIYAT),2) > 6000
                    THEN (CASE WHEN ROUND(HZ.SUT_FIYAT * HH.MIKTAR)>6000 THEN 0 ELSE ROUND(HZ.SUT_FIYAT * HH.MIKTAR) END)
                 ELSE 0 END AS KURUM_TUTARI#Z,
            CASE WHEN SUBSTR (HZ.SUT_RESMI_KODU,1,1) LIKE '8%' AND B.UZMANLIK_KODU IN (4400) 
                     THEN NULL 
                 WHEN SUBSTR(HZ.SUT_RESMI_KODU,1,7)=('520.030')  
                     THEN TO_CHAR(TO_DATE(REPLACE(G.MURACAAT_TARIHI,'/','.')||' '||SUBSTR(G.MURACAAT_TARIHI,1,5),'DD.MM.YYYY HH24:MI'),'YYYYMMDDHH24MI') 
                 ELSE TO_CHAR(HH.ETAR,'YYYYMMDDHH24MI') 
                 END AS RANDEVU_ZAMANI#Z,
           (SELECT K.TC_KIMLIK_NO FROM FONETHBS.KIMLIK K INNER JOIN FONETHBS.KULLANICI KK ON KK.KIMLIK_ID = K.ID WHERE KK.ID = HH.EKUL) AS KULLANICI_KIMLIK_NUMARASI#Z,
            '' AS CIHAZ_NUMARASI#Z,
            HH.ID AS ISLEM_REFERANS_NUMARASI
FROM FONETHBS."HASTA_BIRIM_SEVK"/**/"BS"
INNER JOIN FONETHBS.HASTA_HIZMET HH ON HH.BIRIM_SEVK_ID = BS.ID
INNER JOIN FONETHBS.HIZMET_MAKRO M ON M.ID = HH.MAKRO_ID
INNER JOIN FONETHBS.HIZMET HZ ON HZ.ID = M.HIZMET_ID
INNER JOIN FONETHBS.HASTA_GELIS G ON G.ID = BS.HASTA_GELIS_ID
LEFT JOIN FONETHBS.BIRIM B ON B.ID = BS.BIRIM_ID
WHERE 1=1
AND G.MURACAAT_TARIHI >= '01.01.2015';




CREATE OR REPLACE VIEW V_USS_P102_ILAC AS
SELECT
"CD"."ID" AS DETAY_ID,
"CD"."HASTA_HKID" AS HK_ID,
NVL(
            (SELECT U.SKRSKODU FROM FONETHBYSADM.H_UZMKOD U LEFT JOIN FONETHBYSADM.H_SERVIS HS ON HS.SR_UZMKOD_ID = U.ID WHERE HS.SR_ID = CD.ISTEM_SR ),
            NVL(
                    DECODE(
                            CD.HASTA_YERID,3,
                            (SELECT U.SKRSKODU FROM FONETHBYSADM.H_UZMKOD U INNER JOIN FONETHBYSADM.H_SERVIS S ON U.ID = S.SR_UZMKOD_ID INNER JOIN H_YHSERVIS YS ON S.SR_ID = YS.SERVISID WHERE YS.ID = CD.HASTA_REFID),
                            (SELECT U.SKRSKODU FROM FONETHBYSADM.H_UZMKOD U INNER JOIN FONETHBYSADM.H_SERVIS S ON U.ID = S.SR_UZMKOD_ID INNER JOIN H_POLIKLINIK P ON S.SR_ID = P.POLID WHERE P.ID = CD.HASTA_REFID)
                          ),
                     (SELECT U.SKRSKODU FROM FONETHBYSADM.H_UZMKOD U INNER JOIN FONETHBYSADM.H_SERVIS S ON U.ID = S.SR_UZMKOD_ID INNER JOIN H_HASTAKAYIT HK ON S.SR_ID = HK.HK_SERVISID WHERE HK.HK_ID = CD.HASTA_HKID)
            )
      ) AS KLINIK_KODU#K,
USS.GET_GUID_VALUE('c04bee57-c5d4-443d-e040-7b0a6f146a3d',NVL(
            (SELECT U.SKRSKODU FROM FONETHBYSADM.H_UZMKOD U LEFT JOIN FONETHBYSADM.H_SERVIS HS ON HS.SR_UZMKOD_ID = U.ID WHERE HS.SR_ID = CD.ISTEM_SR ),
            NVL(
                    DECODE(
                            CD.HASTA_YERID,3,
                            (SELECT U.SKRSKODU FROM FONETHBYSADM.H_UZMKOD U INNER JOIN FONETHBYSADM.H_SERVIS S ON U.ID = S.SR_UZMKOD_ID INNER JOIN H_YHSERVIS YS ON S.SR_ID = YS.SERVISID WHERE YS.ID = CD.HASTA_REFID),
                            (SELECT U.SKRSKODU FROM FONETHBYSADM.H_UZMKOD U INNER JOIN FONETHBYSADM.H_SERVIS S ON U.ID = S.SR_UZMKOD_ID INNER JOIN H_POLIKLINIK P ON S.SR_ID = P.POLID WHERE P.ID = CD.HASTA_REFID)
                          ),
                     (SELECT U.SKRSKODU FROM FONETHBYSADM.H_UZMKOD U INNER JOIN FONETHBYSADM.H_SERVIS S ON U.ID = S.SR_UZMKOD_ID INNER JOIN H_HASTAKAYIT HK ON S.SR_ID = HK.HK_SERVISID WHERE HK.HK_ID = CD.HASTA_HKID)
            )
      )) AS KLINIK_KODU#A#Z,
'c04bee57-c5d4-443d-e040-7b0a6f146a3d' AS KLINIK_KODU#C,
TO_CHAR(GREATEST("CD"."ETAR",X.HK_EKLETARIHI), 'YYYYMMDDHH24MI') AS GERCEKLESME_ZAMANI#Z,
DECODE(S.MALZEMETURID,0,2,1,3) AS ISLEM_TURU#K,
USS.GET_GUID_VALUE('d03e562d-252e-451f-9a80-98d48b47c2f2',DECODE(S.MALZEMETURID,0,'2',1,'3')) AS ISLEM_TURU#A,
'd03e562d-252e-451f-9a80-98d48b47c2f2' AS ISLEM_TURU#C,
SUBSTR(REPLACE(S.BARKODNO,'.',''),1,6) AS ISLEM_KODU#Z,
S.ADI AS ISLEM_ADI#Z,
'' AS GIRISIMSEL_ISLEM_KODU#Z,
TO_CHAR(GREATEST(CD.ETAR,X.HK_EKLETARIHI), 'YYYYMMDDHH24MI') AS ISLEM_ZAMANI#Z,
"CD"."MIKTAR" AS ADET#Z,
ROUND(DECODE("CD"."ODEMETURU",'Ücretli', CD.MIKTAR * CD.FIYAT),2) AS HASTA_TUTARI#Z,
ROUND(DECODE(CD.ODEMETURU,'Sevkli', CD.MIKTAR * CD.FIYAT),2) AS KURUM_TUTARI#Z,
TO_CHAR(CD.ETAR, 'YYYYMMDDHH24MI') AS RANDEVU_ZAMANI#Z,
K.TCKIMLIKNO AS KULLANICI_KIMLIK_NUMARASI#Z,
'' AS CIHAZ_NUMARASI#Z,
CD.ID AS ISLEM_REFERANS_NUMARASI
FROM "STOK_CIKISDETAY"/**/"CD"
INNER JOIN FONETHBYSADM.STOK_TNM_STOK S ON S.ID = "CD"."STOKID"
LEFT JOIN STOK_ORDERDETAY OD ON OD.ID = "CD"."ORDER_DETAYID"
LEFT JOIN FONETHBYSADM.YTK_KULLANICI K ON K.ID = "CD"."EKUL"
LEFT JOIN H_HASTAKAYIT X ON X.HK_ID="CD"."HASTA_HKID"
WHERE "CD"."FORMTYPE" IN (1,2)
AND S.MALZEMETURID IN (0,1)
AND X.HK_MURACAATTAR >= '01.01.2015'
--AND X.HK_MUAYENE='E'
AND CD.HASTA_HKID > 0;



CREATE OR REPLACE VIEW V_USS_P102_HIZMET_PUAN AS
SELECT
T.HIID AS DETAY_ID,
P.P_TCKIMLIK AS HEKIM_KIMLIK_NUMARASI#Z,
T.TOPLAMPUAN AS ISLEM_PUANI#Z,
TO_CHAR(T.TARIH, 'YYYYMMDD') || REPLACE(T.SAAT, ':', '') AS PUAN_HAKEDIS_ZAMANI#Z
FROM V_IST2_EKPRIM_LIST T
INNER JOIN FONETHBYSADM.H_PERSON P ON P.P_ID = T.DOKTORID
WHERE T.ONAYDURUM = 1
AND USS.IS_VALID_TC_KIMLIK_NO(P.P_TCKIMLIK) = 1
AND T.TARIH >= '01.01.2015';





